<!DOCTYPE html>
<html lang="en">
	<head>
		<style>
            body{
				background: #f2f2f2;
				font-family: Consolas, monaco, monospace;
			}

            h1{
				text-align: center;
				color: black;
				font-size: 45px;
				margin-bottom: 15px;
			}

			h2{
				font-size: 23px;
				text-align: left;
				margin-bottom: 15px;
			}

            div.form {
				text-align: center;
				font-size: 20px;
			}
            
            form [type = text] {
				width: 15%;
				border: 2px solid black;
				border-radius:4px;
				padding: 5px 5px;
				margin: 5px;
				box-sizing: border-box;
				font-family: inherit;
            }

            button{
				background-color: lightblue;
				border: none;
				color: black;
				border-radius: 4px;
				padding: 8px 16px;
				text-decoration: none;
				margin: 4px 2px;
				cursor: pointer;
				transition-duration:0.2s;
				font-family: inherit;
                font-weight: bold;
			}

			button:hover {
                background-color: black;
				color: lightblue;
            }

			table, th, td{
				width: 30%;
				border: 1.5px solid black;
				border-collapse: collapse;
				margin-bottom: 15px;
			}
			th{
				background-color: lightblue;
			}
			select{
				width: 200px;
				padding: 8px;
				font-size: 15px;
				border: 1px solid gray;
				border-radius: 4px;
				background-color: white;
				color: #333;
				font-family:inherit;
			}
			option{
				font-family: inherit;
			}
			select:focus{
				outline:none;
				border-color: black;
			}
        </style>
		<title>Welcome</title>
	</head>
	<body>
		<h1>Welcome</h1>
		<div class="form">
			<br>Add an item to database<br>
			<br>
			<form action="/additem" method="POST">			
				<label for="inputTitle">Title</label>
				<input type="text" name="intitle">
				<br>
				
				<label for="inputDesc">Description: </label>
				<input type="text" name="indescription">
				<br>
				
				<label for="inputCategory">Category: </label>
				<input type="text" name="incategory">
				<br>
				
				<label for="inputPrice">Price: </label>
				<input type="text" name="inprice">
				<br>
				<button type="submit">Add Item</button>
			</form>
		</div>	
		
		<hr>
		<div class="form">
			<br>Query 1 - Most expensive item by category</br>
			<br>
			<form>
				<table>
					<tr>
						<th>Category</th>
						<th>Price</th>
					</tr>
					<tbody id="maxresult">
					</tbody>					
				</table>	
				<button id="maxbutton">List Items</button>
			</form>
		</div>
				
		<hr>
		<div class="form">
			<br>Query 3 - Items with all "Excellent" or "Good" reviews</br>
			<br>
			<form id="excelform" action="/excellentitems" method="POST">
				<label for = "exceluser">Enter a username: </label>
				<input type="text" id="excelinput" name="exceluser" placeholder="Enter Username">
				<br>
				<button type="submit">List Items</button>
			</form>
			
			<table id="exceltable">
				<tr>
					<th>Username</th>
					<th>Title</th>
				</tr>
				<tbody id="excelresult">
				
				</tbody>					
			</table>	
				
			</form>
		</div>
		
		<hr>
		<div class="form">
			<br>Query 7 - Users who never posted a "Poor" review</br>
			<br>
			<br>
			<form>
				<table>
					<tr>
						<th>Username</th>
					</tr>
					<tbody id="nopoorresult">
					</tbody>
				</table>
				<button id="nopoorbutton">List Users</button>
			</form>
		</div>
		
		<hr>
		<div class="form">
			<br>Query 8 - Users who posted all "Poor" reviews</br>
			<br>
			<form>
				<table>
					<tr>
						<th>Username</th>
					</tr>
					<tbody id="allpoorresult">
					</tbody>
				</table>
				<button id="allpoorbutton">List Users</button>
			</form>
		</div>

		<hr>Riley<hr>
		<div id="container">
			<div class="form">	
				<form id="search-form" action="/searchcategory" method="POST">
					<label for="category">Enter a category: </label>
					<input type="text" id="input" name="category" placeholder="Category">
					<button type="submit">Search</button>
				</form>
			<h2>Results:</h2>
			<table id="results-table">
				<thead>
					<tr>
						<th>Items</th>
						<th>Category</th>
					</tr>
				</thead>
				<tbody id="results-body">
				</tbody>
			</table>
			</div>
			<div class="form">
				<br>Search Users by Categories<br>
				<form id="search-categories-form" action="/searchUsersByCategories" method="POST">
					<label for="category1">Category 1:</label>
					<input type="text" id="category1" name="category1" placeholder="Category 1">
					<br>
			
					<label for="category2">Category 2:</label>
					<input type="text" id="category2" name="category2" placeholder="Category 2">
					<br>
			
					<button type="submit" id="searchCategories">Search Users</button>
				</form>
				<h2>Query 2 - Users who posted at least two items in a day:</h2>
				<table id="users-table">
					<thead>
						<tr>
							<th>Username</th>
						</tr>
					</thead>
					<tbody id="users-result">
					</tbody>
				</table>
			</div>
			<div class="form">
				<br>Most Reviews on 2023-09-21<br>
				<form id="most-reviews-form" action="/mostReviewsOnDate" method="POST">
					<button type="submit">Display Users</button>
				</form>
				<h2>Query 4 - Users with the most reviews on 2023-09-21:</h2>
				<table id="most-reviews-table">
					<thead>
						<tr>
							<th>Username</th>
							<th>Number of Reviews</th>
						</tr>
					</thead>
					<tbody id="most-reviews-result">
					</tbody>
				</table>
			</div>
			<div class="form">
				<h2>User Favorites</h2>
				<br>Favorite a Seller<br>
				<form id="favorite-sellers-form">
					<label for="sellerSelect">Select a seller:</label>
					<select id="sellerSelect" name="seller_id"></select>
					<button type="button" id="addToFavoriteSellers">Add to Favorites</button>
				</form>
				<table id="favorite-sellers-table"></table>
			</div>
			<div class="form">
				<br>Favorite an Item<br>
				<form id="favorite-items-form">
					<label for="itemSelect">Select an item:</label>
					<select id="itemSelect" name="item_id"></select>
					<button type="button" id="addToFavoriteItems">Add to Favorites</button>
				</form>
				<table id="favorite-items-table"></table>
			</div>
			<div class="form" id="commonFavoriteSellers">
				<h2>Query 5 - Common favorite sellers:</h2>
				
				<label for="user1Select">Select first user:</label>
				<select id="user1Select" name="user1"></select>
			
				<label for="user2Select">Select second user:</label>
				<select id="user2Select" name="user2"></select>
			
				<button type="button" id="getCommonFavoriteSellersBtn">Get Sellers</button>
			
				<table id="commonFavoriteSellersTable">
					<thead>
						<tr>
							<th>First user</th>
							<th>Second user</th>
							<th>Common seller</th>
						</tr>
					</thead>
					<tbody id="commonFavoriteSellersTableBody"></tbody>
				</table>
			</div>
		</div> <!-- riley end -->

		<!-- Javier HTML START -->
		<hr>java<hr>
		<div id="add-review">
			<h2>Add a Review:</h2>
			<form id="review-form">
				<label for="addReviewSelect">Select an item:</label>
				<select id="addReviewSelect" name="item_id">
					<!-- Placeholder option -->
					<option value="" disabled selected>Select an item</option>
				</select>

				<br>
				<label for="ratingSelect">Select a rating:</label>
				<select id="ratingSelect" name="rating">
					<option value="excellent">Excellent</option>
					<option value="good">Good</option>
					<option value="fair">Fair</option>
					<option value="poor">Poor</option>
				</select>
				<br>
				<label for="reviewText">Review:</label>
				<textarea id="reviewText" name="reviewText" rows="4" cols="50"></textarea>
				<br>
				<button type="button" id="submitReview">Submit Review</button>
			</form>
		</div>



		
	<!--Query 6 Phase 3-->
		<div>
			<h2>
				Query 6 - Display all the users who never posted any "excellent" items: an item is excellent if at least
				three reviews are excellent.
			</h2>
		</div>
		<!--Button for Query 6 Phase 3-->
		<button id="showNonExcellentUsers">Show Users with No Excellent Items</button>
		<table id="nonExcellentUsersResult">
			<!-- Table headers -->
			<thead>
				<tr>
					<th>Username</th>
				</tr>
			</thead>
			<!-- Table body (will be populated dynamically) -->
			<tbody>
			</tbody>
		</table>



			<!--Query 9 Phase 3-->
		<div>
			<h2>
				Display those users such that each item they posted so far never received any "poor" reviews.
			</h2>
		</div>
		<button id="NoPoorReviewsBtn">Show No Poor Reviews Table</button>
		<table id="NoPoorReviewsResult">
			<thead>
				<tr>
					<th>Username</th>
					<th>Item</th>
					<th>Rating</th>
				</tr>
			</thead>
			<!-- Table will be populated dynamically -->
			<tbody id="noPoorReviewsResultBody">
			</tbody>
		</table>




		<div>
	<!--Query 10 Phase 3-->
			<h2>
				Query 10 - List a user pair (A, B) such that they always gave each other "excellent" reviews for every single
				item they posted.
			</h2>
			<!--Button for Query 10 Phase 3-->
			<button id="excellentReviewPairsBtn" type="button">Show Excellent Review Pairs</button>

			<table id="excellentReviewPairsResult">
				<!-- Table headers -->
				<thead>
					<tr>
						<th>User A</th>
						<th>User B</th>
					</tr>
				</thead>
				<!-- Table body (will be populated dynamically) -->
				<tbody>
				</tbody>
			</table>
		</div>
	<!--Javier End -->
		
		<hr>
		<h2>Create table button</h2>
			<form action="/createtable" method="post">
				<button type="submit" class="mybutton">Create table</button>
			</form>
		<hr>
		<a href="\">Logout</a>

		<!--Script to handle review calls when submit button is pressed-->
		<script>
		 // Function to populate items dropdown
            function populateItemsDropdown() {
                fetch('/items') // endpoint to retrieve items
                    .then(response => response.json())
                    .then(data => {
                        const addReviewSelect = document.getElementById('addReviewSelect');

                        // Clear existing options
                        addReviewSelect.innerHTML = '<option value="" disabled selected>Select an item</option>';

                        // Populate the dropdown with retrieved items
                        data.forEach(item => {
                            const option = document.createElement('option');
                            option.value = item.id;
                            option.textContent = item.name;
                            addReviewSelect.appendChild(option);
                        });
                    })
                    .catch(error => {
                        console.error('Error fetching items:', error);
                    });
            }

            // Event listener for page load
            document.addEventListener('DOMContentLoaded', function () {
                // Populate items dropdown on page load
                populateItemsDropdown();

                // Event listener for submitting reviews
                document.getElementById('submitReview').addEventListener('click', function () {
                    const item_id = document.getElementById('addReviewSelect').value;
                    const rating = document.getElementById('ratingSelect').value;
                    const reviewText = document.getElementById('reviewText').value;

                    // Check if an item is selected
                    if (!item_id) {
                        alert('Please select an item before submitting a review.');
                        return;
                    }

                    const data = { item_id, rating, reviewText };

                    fetch('/submitreview', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(data),
                    })
                        .then(response => {
                            if (response.ok) {
                                console.log('Review submitted successfully');
                                alert('Review submitted successfully');
                                document.getElementById('reviewText').value = ''; // Clear the review text area

                                // Repopulate the items dropdown after submitting a review
                                populateItemsDropdown();
                            } else if (response.status === 403) {
                                console.log('You have already submitted three reviews today.');
                                alert('You have already submitted three reviews today.');
                            } else {
                                response.text().then(errorMessage => {
                                    console.log('Error:', errorMessage);
                                    alert('Error: ' + errorMessage);
                                });
                            }
                        })
                        .catch(error => {
                            console.error('Error:', error);
                            alert('An error occurred. Please try again.');
                        });
                });
            });


	
			/*code for Query 1*/
			const baseUrl = 'http://localhost:3000/maxcat';
			const maxBtn = document.getElementById('maxbutton');
			//const input = document.getElementById('input');
			const maxresult = document.getElementById('maxresult');

			maxBtn.addEventListener('click', getMax);

			async function getMax(e) {
				e.preventDefault()
				const res = await fetch(baseUrl, 
				{
					method: 'GET'

				})
				const data0 = await res.json()
				maxresult.innerHTML = "";
				//input.innerHTML = data[1].max
				
				data0.forEach(e =>{
					const row0 = document.createElement("tr");
					row0.innerHTML = `<td>${e.category}</td><td>${e.max}</td>`
					maxresult.appendChild(row0);	
				})
			}

			
				
			/*Code for query 2*/
			const searchCategoriesForm = document.getElementById("search-categories-form");
			const usersTable = document.getElementById("users-table");
			const usersResultBody = document.getElementById("users-result");
		
			searchCategoriesForm.addEventListener("submit", async (e) => {
				e.preventDefault();
				const category1 = document.getElementById("category1").value;
				const category2 = document.getElementById("category2").value;
		
				const response = await fetch("/searchUsersByCategories", {
					method: "POST",
					headers: {
						"Content-Type": "application/json",
					},
					body: JSON.stringify({ category1, category2 }),
				});
		
				if (response.ok) {
					const data = await response.json();
		
					usersResultBody.innerHTML = ""; // Clear previous results
		
					data.users.forEach(username => {
						const row = document.createElement("tr");
						row.innerHTML = `<td>${username}</td>`;
						usersResultBody.appendChild(row);
					});
				} else {
					console.error("Error in searchUsersByCategories:", response.statusText);
					usersResultBody.innerHTML = "<p>An error occurred while searching for users.</p>";
				}
			});
				
			/*code for Query 3*/
			const excelForm = document.getElementById("excelform");
			const excelTable = document.getElementById("exceltable");
			const excelResult = document.getElementById("excelresult");
			
			
			excelForm.addEventListener("submit", getExcel);
			
			async function getExcel(e) {
				e.preventDefault();
				const user = document.getElementById("excelinput").value;
				
				const ress = await fetch("/excellentitems", {
					method: "POST",
					headers: { "Content-Type" : "application/json"},
					body: JSON.stringify({user})
					});
				console.log(user);
				const response = await fetch("/excellentitems", {
					method: "POST",
					headers: {
						"Content-Type": "application/json",
					},
					body: JSON.stringify({ user }),
				});
				const test = await response.json();
				excelResult.innerHTML = "";
				console.log(test);
				
				test.forEach(e =>{
					const row3 = document.createElement("tr");
					row3.innerHTML = `<td>${e.username}</td><td>${e.title}</td>`
					excelResult.appendChild(row3);	
				})
			}
			
			/*Code for query 4*/
			const mostReviewsForm = document.getElementById("most-reviews-form");
			const mostReviewsTable = document.getElementById("most-reviews-table");
			const mostReviewsResultBody = document.getElementById("most-reviews-result");
		
			mostReviewsForm.addEventListener("submit", async (e) => {
				e.preventDefault();
		
				const response = await fetch("/mostReviewsOnDate", {
					method: "POST",
					headers: {
						"Content-Type": "application/json",
					},
				});
		
				if (response.ok) {
					const data = await response.json();

					usersResultBody.innerHTML = "";
		
					data.users.forEach(user => {
						const row = document.createElement("tr");
						row.innerHTML = `<td>${user.username}</td><td>${user.num_reviews}</td>`;
						mostReviewsResultBody.appendChild(row);
					});
		
				} else {
					console.error("Error in mostReviewsOnDate:", response.statusText);
					mostReviewsResultBody.innerHTML = "<p>An error occurred while fetching users with the most reviews.</p>";
				}
			});
			
			/*Code for Adding favorites */
			document.addEventListener('DOMContentLoaded', function () {
				// Function to populate a dropdown
				function populateFavDropdown(dropdown, endpoint) {
					fetch(endpoint)
						.then(response => response.json())
						.then(data => {
							data.forEach(item => {
								const option = document.createElement('option');
								option.value = item.id;
								option.text = item.name;
								dropdown.appendChild(option);
							});
						})
						.catch(error => {
							console.error('Error fetching data:', error);
						});
				}
		
				// Function to add to favorites
				function addToFavorites(endpoint, selectedId, favType) {
					fetch(endpoint, {
						method: 'POST',
						headers: {
							'Content-Type': 'application/json',
						},
						body: JSON.stringify({ id: selectedId, fav_type: favType }),
					})
					.then(response => response.json())
					.then(data => {
						console.log(data);
						if (data.success) {
							alert(data.message);
						} else {
							alert('Error adding to favorites:', data.message);
						}
					})
					.catch(error => {
						console.error('Error adding to favorites:', error);
					});
				} 
		
				// Fetch and populate sellers dropdown
				const sellerSelect = document.getElementById('sellerSelect');
				populateFavDropdown(sellerSelect, '/sellers');
		
				// Fetch and populate items dropdown
				const itemSelect = document.getElementById('itemSelect');
				populateFavDropdown(itemSelect, '/items');
		
				// Event listeneer for favorite sellers button
				document.getElementById('addToFavoriteSellers').addEventListener('click', function () {
					const selectedSellerId = sellerSelect.value;
					addToFavorites('/addToFavorites', selectedSellerId, 'seller');
				});
		
				// Event listener for favorite items button
				document.getElementById('addToFavoriteItems').addEventListener('click', function () {
					const selectedItemId = itemSelect.value;
					addToFavorites('/addToFavorites', selectedItemId, 'item');
				});
			});

			/*Code for query 5*/
			document.addEventListener('DOMContentLoaded', function () {

				function populateComFavDropdown(dropdown, endpoint) {
					fetch(endpoint)
						.then(response => response.json())
						.then(data => {
							console.log(data);
							data.forEach(item => {
								const option = document.createElement('option');
								option.value = item.name;
								option.text = item.name;
								dropdown.appendChild(option);
							});
						})
						.catch(error => {
							console.error('Error fetching data:', error);
						});
				}
		
				// Function to get common favorite sellers
				function getCommonFavoriteSellers(user1, user2) {
					console.log(`User 1: ${user1}, User 2: ${user2}`);
					const tableBody = document.getElementById('commonFavoriteSellersTableBody');
					while (tableBody.firstChild) {
						tableBody.removeChild(tableBody.firstChild);
					}

					fetch('/getCommonFavoriteSellers', {
						method: 'POST',
						headers: {
							'Content-Type': 'application/json',
						},
						body: JSON.stringify({ user1, user2 }),
					})
					.then(response => response.json())
					.then(data => {
						console.log(data);
						
						if (data.length === 0) {
							alert('No common favorite sellers found.');
						} else {
							data.forEach(item => {
							const row = document.createElement("tr");
							row.innerHTML = `<td>${item.user1}</td><td>${item.user2}</td><td>${item.common_fav_seller}</td>`;
							tableBody.appendChild(row);
							});
						}
						
					})
					.catch(error => {
						console.error('Error fetching common favorite sellers:', error);
					});
				}
		
				// Fetch and populate users 1 dropdown using 'name' property
				const user1Select = document.getElementById('user1Select');
				populateComFavDropdown(user1Select, '/sellers');

				// Fetch and populate users 2 dropdown using 'name' property
				const user2Select = document.getElementById('user2Select');
				populateComFavDropdown(user2Select, '/sellers');

				// Add event listener for Get Common Sellers button
				document.getElementById('getCommonFavoriteSellersBtn').addEventListener('click', function () {
					const user1 = user1Select.value;
					const user2 = user2Select.value;

					console.log('Selected User 1:', user1);
					console.log('Selected User 2:', user2);

					getCommonFavoriteSellers(user1, user2);
				});
			});

				//Code for Query 6
				document.getElementById('showNonExcellentUsers').addEventListener('click', function () {
					fetch('/nonExcellentUsers', {
						method: 'GET',
						headers: {
							'Content-Type': 'application/json'
						},
					})
						.then(response => response.json())
						.then(data => {
							// Get the table body
							const tableBody = document.getElementById('nonExcellentUsersResult').getElementsByTagName('tbody')[0];

							// Clear existing rows
							tableBody.innerHTML = '';

							// Populate the table dynamically
							data.users.forEach(username => {
								const row = tableBody.insertRow();
								const cell = row.insertCell(0);
								cell.textContent = username;
							});
						})
						.catch(error => {
							console.error('Error fetching non-excellent users:', error);
						});
				});
			


			
			
			/*code for Query 7*/
			const baseUrl7 = 'http://localhost:3000/nopoor';
			const poorBtn = document.getElementById('nopoorbutton');
			const nopoorResult = document.getElementById('nopoorresult');
			
			poorBtn.addEventListener('click', excPoor);
			
			async function excPoor(e){
				e.preventDefault();
				const res = await fetch(baseUrl7, 
				{
					method: 'GET'
				})
				const data7 = await res.json()
				console.log(data7);
				nopoorResult.innerHTML = "";
				
				data7.forEach(e =>{
					const row7 = document.createElement("tr");
					row7.innerHTML = `<td>${e.username}</td>`
					nopoorResult.appendChild(row7)
					})
			}
			
			const baseUrl8 = 'http://localhost:3000/allpoor';
			const allpoorBtn = document.getElementById('allpoorbutton');
			const allpoorResult = document.getElementById('allpoorresult');
			
			allpoorBtn.addEventListener('click', getAllPoor);
			
			async function getAllPoor(e){
				e.preventDefault();
				const res = await fetch(baseUrl8,
				{
					method: 'GET'
				})
				const data8 = await res.json();
				console.log(data8);
				allpoorResult.innerHTML = "";
				
				data8.forEach(e => {
					const row8 = document.createElement("tr");
					row8.innerHTML = `<td>${e.username}</td>`
					allpoorResult.appendChild(row8);
				})
			}
		
		/*Phase 2 search*/
		const searchForm = document.getElementById("search-form");
		const resultsTable = document.getElementById("results-table");
		const resultsBody = document.getElementById("results-body");

		searchForm.addEventListener("submit", async (e) => {
			e.preventDefault();
			const category = document.getElementById("input").value;

			// Send a POST request to the server to fetch results for the given category
			const response = await fetch("/searchcategory", {
				method: "POST",
				headers: {
					"Content-Type": "application/json",
				},
				body: JSON.stringify({ category }),
			});

			if (response.ok) {
				const data = await response.json();
				resultsBody.innerHTML = ""; // Clear previous results

				data.forEach(item => {
					const row = document.createElement("tr");
					row.innerHTML = `<td>${item.title}</td><td>${item.category}</td>`;
					resultsBody.appendChild(row);
				});
			}
		});




			/*Code for Query 9*/
            document.getElementById('NoPoorReviewsBtn').addEventListener('click', function () {
                fetch('/NoPoorReviews', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                })
                    .then(response => response.json())
                    .then(data => {
                        // Get the table body
                        const tableBody = document.getElementById('noPoorReviewsResultBody');

                        // Clear existing rows
                        tableBody.innerHTML = '';

                        // Populate the table dynamically
                        data.items.forEach(result => {
                            const row = tableBody.insertRow();
                            const usernameCell = row.insertCell(0);
                            const itemCell = row.insertCell(1);
                            const ratingCell = row.insertCell(2);

                            usernameCell.textContent = result.username;
                            itemCell.textContent = result.item;
                            ratingCell.textContent = result.rating;
                        });
                    })
                    .catch(error => {
                        console.error('Error fetching users with no poor reviews:', error);
                    });
            });

		/*Code for Query 10*/
			document.getElementById('excellentReviewPairsBtn').addEventListener('click', function () {
				fetch('/excellentReviewPairs', {
					method: 'GET',
					headers: {
							'Content-Type': 'application/json'
						},
					})
						.then(response => response.json())
						.then(data => {
							// Get the table body
							const tableBody = document.getElementById('excellentReviewPairsResult').getElementsByTagName('tbody')[0];

							// Clear existing rows
							tableBody.innerHTML = '';

							// Populate the table dynamically
							data.pairs.forEach(pair => {
								const row = tableBody.insertRow();
								const cellA = row.insertCell(0);
								const cellB = row.insertCell(1);
								cellA.textContent = pair.userA;
								cellB.textContent = pair.userB;
							});
						})
						.catch(error => {
							console.error('Error fetching excellent review pairs:', error);
						});
				});

		

			
		</script>
	
	</body>
</html>
